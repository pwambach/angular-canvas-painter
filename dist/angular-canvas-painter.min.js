"use strict";!function(){angular.module("pw.canvas-painter",[]),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",function(){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(e,t){var n=e.options;if(n.canvasId=n.customCanvasId||"pwCanvasMain",n.tmpCanvasId=n.customCanvasId?n.canvasId+"Tmp":"pwCanvasTmp",n.width=n.width||400,n.height=n.height||300,n.backgroundColor=n.backgroundColor||"#fff",n.color=n.color||"#000",n.undoEnabled=n.undoEnabled||!1,n.opacity=n.opacity||.9,n.lineWidth=n.lineWidth||1,n.undo=n.undo||!1,n.imageSrc=n.imageSrc||!1,n.imageSrc){var o=new Image;o.onload=function(){c.drawImage(this,0,0)},o.src=n.imageSrc}if(n.undo){var a=[];e.$watch(function(){return a.length},function(t){e.version=t}),e.$watch("version",function(t){return 0>t?(e.version=0,void 0):t>=a.length?(e.version=a.length,void 0):(g(t),void 0)})}var i=document.createElement("canvas");i.id=n.canvasId;var r=document.createElement("canvas");r.id=n.tmpCanvasId,angular.element(r).css({position:"absolute",top:0,left:0}),t.find("div").append(i),t.find("div").append(r);var c=i.getContext("2d"),l=r.getContext("2d"),s={x:0,y:0},u=[];i.width=r.width=n.width,i.height=r.height=n.height,c.fillStyle=n.backgroundColor,c.fillRect(0,0,i.width,i.height),l.globalAlpha=n.opacity,l.lineJoin=l.lineCap="round",l.lineWidth=10,l.strokeStyle=n.color,e.$watch("options.lineWidth",function(e){"string"==typeof e&&(e=parseInt(e,10)),e&&"number"==typeof e&&(l.lineWidth=n.lineWidth=e)}),e.$watch("options.color",function(e){e&&(l.strokeStyle=l.fillStyle=e)}),e.$watch("options.opacity",function(e){e&&(l.globalAlpha=e)});var d=function(e){var t=0,n=0;do isNaN(e.offsetLeft)||(t+=e.offsetTop,n+=e.offsetLeft),e=e.offsetParent;while(e);return{left:n,top:t}},v=function(e,t){e.x=void 0!==t.offsetX?t.offsetX:t.layerX,e.y=void 0!==t.offsetY?t.offsetY:t.layerY,t.changedTouches&&(e.x=t.changedTouches[0].pageX-d(t.target).left,e.y=t.changedTouches[0].pageY-d(t.target).top)},p=function(e){if(e&&(e.preventDefault(),v(s,e)),u.push({x:s.x,y:s.y}),3===u.length){var t=u[0];return l.beginPath(),l.arc(t.x,t.y,l.lineWidth/2,0,2*Math.PI,!0),l.fill(),l.closePath(),void 0}l.clearRect(0,0,r.width,r.height),l.beginPath(),l.moveTo(u[0].x,u[0].y);for(var n=1;n<u.length-2;n++){var o=(u[n].x+u[n+1].x)/2,a=(u[n].y+u[n+1].y)/2;l.quadraticCurveTo(u[n].x,u[n].y,o,a)}l.quadraticCurveTo(u[n].x,u[n].y,u[n+1].x,u[n+1].y),l.stroke()},h=function(){n.undo&&e.$apply(function(){a.push(c.getImageData(0,0,r.width,r.height)),angular.isNumber(n.undo)&&n.undo>0&&(a=a.slice(-1*n.undo))}),r.removeEventListener("touchmove",p,!1),r.removeEventListener("mousemove",p,!1),c.drawImage(r,0,0),l.clearRect(0,0,r.width,r.height),u=[]},f=function(e){e.preventDefault(),r.addEventListener("touchmove",p,!1),r.addEventListener("mousemove",p,!1),v(s,e),u.push({x:s.x,y:s.y}),u.push({x:s.x,y:s.y}),p()},m=function(){function t(){c=!0}function n(){c=!1}function o(){document.body.removeEventListener("mousedown",t),document.body.removeEventListener("mouseup",n)}function a(e){c&&f(e)}function i(e){c&&h(e)}r.addEventListener("touchstart",f,!1),r.addEventListener("mousedown",f,!1),r.addEventListener("touchend",h,!1),r.addEventListener("mouseup",h,!1);var c;document.body.addEventListener("mousedown",t),document.body.addEventListener("mouseup",n),e.$on("$destroy",o),r.addEventListener("mouseenter",a),r.addEventListener("mouseleave",i)},g=function(e){a.length>0&&(c.putImageData(a[e],0,0),a=a.slice(0,e))};m()}}}),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(e){e.setColor=function(t){e.selectedColor=t}}}})}(this);